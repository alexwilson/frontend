on:
  push:
    # Respond to a push event on every brannch other than Github Pages.
    branches:
      - '!gh-pages'
      - '*'

  pull_request:
    branches:
      - '!gh-pages'

  # Scheduled build so pipeline failures are noticed quicker.
  schedule:
    - cron: '30 4 * * 3,6'

name: Build, Test and Deploy
jobs:

  # Fetch dependencies and build Gatsby
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@master
      with:
        fetch-depth: 1
    - name: Restore Cached Build
      uses: actions/cache@v1
      id: cache-public
      with:
        path: packages/personal-website/public
        key: build
    - uses: actions/setup-node@master
    - name: Restore NPM Cache
      uses: actions/cache@v1
      id: cache-npm
      with:
        path: ~/.npm
        key: npm-${{ hashFiles('**/package-lock.json') }}
    - name: Restore node_modules
      uses: actions/cache@master
      id: cache-node_modules
      with:
        key: node_modules-${{ hashFiles('**/package-lock.json') }}
        path: |
          node_modules
          */*/node_modules
    - name: Install Dependencies
      run: npm ci
    - name: Build
      run: npm run build
      env:
        CI: true
    - name: Save Build Artefact
      uses: actions/upload-artifact@v1
      with:
        name: site-artefact
        path: packages/personal-website/public

  # Run unit tests on the artefact we just built.
  test:
    name: Test
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@master
      with:
        fetch-depth: 1
    - name: Download Website Artefact
      uses: actions/download-artifact@v1
      with:
        name: site-artefact
        path: public
    - uses: actions/setup-node@master
    - name: Restore NPM Cache
      uses: actions/cache@v1
      id: cache-npm
      with:
        path: ~/.npm
        key: npm-${{ hashFiles('**/package-lock.json') }}
    - name: Restore node_modules
      uses: actions/cache@master
      id: cache-node_modules
      with:
        key: node_modules-${{ hashFiles('**/package-lock.json') }}
        path: |
          node_modules
          */*/node_modules
    - name: Install Dependencies
      run: npm ci
    - name: Run Tests
      run: npm test

  # Deploy to Github Pages environment
  deploy-production:
    name: Deploy Gatsby to Github Pages
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'
    steps:
    - name: Checkout
      uses: actions/checkout@master
      with:
        fetch-depth: 1
    - name: Download Website Artefact
      uses: actions/download-artifact@v1
      with:
        name: site-artefact
        path: public
    - name: Deploy to Github Pages
      uses: ./.github/actions/github-pages/
      env:
        GITHUB_TOKEN: ${{ secrets.PAGES_GH_TOKEN }}
      with:
        args: public
    - name: Trigger a Pages Update
      run: |
        curl -sS -X POST -H "Authorization: Bearer ${{ secrets.PAGES_GH_TOKEN }}" \
        https://api.github.com/repos/${{ github.repository }}/pages/builds \

  deploy-lerna-production:
    name: "Deploy with Lerna"
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'
    steps:
    - name: Checkout
      uses: actions/checkout@master
      with:
        fetch-depth: 1
    - uses: actions/setup-node@master
    - name: Restore NPM Cache
      uses: actions/cache@v1
      id: cache-npm
      with:
        path: ~/.npm
        key: npm-${{ hashFiles('**/package-lock.json') }}
    - name: Restore node_modules
      uses: actions/cache@master
      id: cache-node_modules
      with:
        key: node_modules-${{ hashFiles('**/package-lock.json') }}
        path: |
          node_modules
          */*/node_modules

    # @TODO: Remove this when Wrangler configuration is simpler
    # Wrangler is never cached as it's added to home directory
    # https://github.com/cloudflare/wrangler/issues/1286
    - name: npm install cargo
      run: npm i @cloudflare/wrangler -g
    - name: Deploy
      run: npm run deploy
      env:
        CI: true
        CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
        CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
